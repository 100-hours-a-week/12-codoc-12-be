name: backend-cd

on:
  workflow_dispatch: {}

permissions:
  contents: read

# 배포는 최신 커밋 기준
concurrency:
  group: backend-cd-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci:
    uses: ./.github/workflows/ci.yml
    secrets: inherit

  deploy:
    needs: [ci]
    runs-on: ubuntu-latest
    env:
      IS_PROD: ${{ github.ref_name == 'main' }}

      AWS_REGION: ${{ github.ref_name == 'develop' && secrets.AWS_REGION_DEV || secrets.AWS_REGION }}
      CODEDEPLOY_APP: ${{ github.ref_name == 'develop' && secrets.CODEDEPLOY_APP_DEV || secrets.CODEDEPLOY_APP }}
      CODEDEPLOY_GROUP: ${{ github.ref_name == 'develop' && secrets.CODEDEPLOY_GROUP_DEV || secrets.CODEDEPLOY_GROUP }}
      S3_BUCKET: ${{ github.ref_name == 'develop' && secrets.DEPLOY_BUCKET_DEV || secrets.DEPLOY_BUCKET }}
      S3_KEY_PREFIX: ${{ github.ref_name == 'develop' && secrets.DEPLOY_KEY_PREFIX_DEV || secrets.DEPLOY_KEY_PREFIX }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Build CodeDeploy Bundle
        run: |
          cd deploy
          zip -r /tmp/codoc-deploy.zip .

      - name: Upload Bundle to S3
        run: |
          KEY="${S3_KEY_PREFIX}/codoc-deploy-${GITHUB_SHA}.zip"
          aws s3 cp /tmp/codoc-deploy.zip "s3://${S3_BUCKET}/${KEY}"
          echo "DEPLOY_S3_KEY=${KEY}" >> $GITHUB_ENV

      - name: Create CodeDeploy Deployment
        run: |
          aws deploy create-deployment \
            --application-name "$CODEDEPLOY_APP" \
            --deployment-group-name "$CODEDEPLOY_GROUP" \
            --revision "revisionType=S3,s3Location={bucket=${S3_BUCKET},key=${DEPLOY_S3_KEY},bundleType=zip}"

      - name: Notify Discord
        if: always()
        run: |
          STATUS="${{ job.status == 'success' && '성공' || '실패' }}"
          COLOR="${{ job.status == 'success' && '65280' || '16711680' }}"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          curl -X POST -H "Content-Type: application/json" \
          -d '{
            "embeds": [{
              "title": "BE CD 결과 (Backend)",
              "description": "상태: '"${STATUS}"'\n브랜치: ${{ github.ref_name }}\n담당자: ${{ github.actor }}",
              "color": '"${COLOR}"',
              "fields": [
                {"name": "커밋 메시지", "value": "${{ github.event.head_commit.message || 'Manual Trigger' }}"},
                {"name": "로그 확인", "value": "'"${RUN_URL}"'"}
              ]
            }]
          }' \
          ${{ secrets.DISCORD_WEBHOOK }}
