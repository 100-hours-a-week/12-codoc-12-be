name: backend-cd

on:
  workflow_call:
    inputs:
      ref_name:
        description: "Branch name from caller workflow"
        required: true
        type: string
      run_id:
        description: "Caller CI workflow run ID to fetch artifacts"
        required: true
        type: string

  workflow_dispatch:
    inputs:
      ref_name:
        description: "Branch name to deploy"
        required: true
        type: string
      run_id:
        description: "CI workflow run ID to fetch artifacts"
        required: true
        type: string

permissions:
  contents: read
  actions: read

concurrency:
  group: backend-cd-${{ inputs.ref_name }}
  cancel-in-progress: true

jobs:
  deploy:
    if: >
      inputs.ref_name == 'develop' ||
      inputs.ref_name == 'feature/dev-auth-kakao' ||
      (github.event_name == 'workflow_dispatch' && inputs.ref_name == 'main')

    runs-on: ubuntu-latest
    env:
      IS_PROD: ${{ inputs.ref_name == 'main' }}

      BE_HOST: ${{ (inputs.ref_name == 'develop' || inputs.ref_name == 'feature/dev-auth-kakao') && secrets.BE_HOST_DEV || secrets.BE_HOST }}
      DEPLOY_USER: ${{ (inputs.ref_name == 'develop' || inputs.ref_name == 'feature/dev-auth-kakao') && secrets.DEPLOY_USER_DEV || secrets.DEPLOY_USER }}
      SSH_PRIVATE_KEY: ${{ (inputs.ref_name == 'develop' || inputs.ref_name == 'feature/dev-auth-kakao') && secrets.SSH_PRIVATE_KEY_DEV || secrets.SSH_PRIVATE_KEY }}
      ENV_CONTENT: ${{ (inputs.ref_name == 'develop' || inputs.ref_name == 'feature/dev-auth-kakao') && secrets.ENV_DEV || secrets.ENV }}

    steps:
      - name: Checkout (for k6 script)
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref_name }}

      # CI run-id에서 아티팩트 가져오기
      - name: Download Backend Artifact (from CI run)
        uses: actions/download-artifact@v4
        with:
          name: backend-jar
          path: ./artifact
          run-id: ${{ inputs.run_id }}
          github-token: ${{ github.token }}

      - name: List downloaded files
        run: |
          echo "Downloaded artifact:"
          ls -al ./artifact
          find ./artifact -maxdepth 2 -type f

      - name: Upload JAR to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.BE_HOST }}
          username: ${{ env.DEPLOY_USER }}
          key: ${{ env.SSH_PRIVATE_KEY }}
          source: "artifact/*.jar"
          target: "/home/ubuntu/be/incoming"
          strip_components: 1

      - name: Execute Backend Deploy Script
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.BE_HOST }}
          username: ${{ env.DEPLOY_USER }}
          key: ${{ env.SSH_PRIVATE_KEY }}
          script: |
            set -e
            cat << 'EOF' > /home/ubuntu/be/.env
            ${{ env.ENV_CONTENT }}
            EOF
            chmod +x /home/ubuntu/be/deploy.sh
            bash /home/ubuntu/be/deploy.sh

      - name: k6 Load Test (Develop Only)
        if: inputs.ref_name == 'develop' || inputs.ref_name == 'feature/dev-auth-kakao'
        uses: grafana/k6-action@v0.3.1
        with:
          filename: k6-scripts/develop-load.js
        env:
          BASE_URL: ${{ secrets.BE_BASE_URL_DEV != '' && secrets.BE_BASE_URL_DEV || format('http://{0}:8080', (secrets.BE_HOST_DEV != '' && secrets.BE_HOST_DEV || secrets.BE_HOST)) }}

      - name: Notify Discord
        if: always()
        run: |
          STATUS="${{ job.status == 'success' && '성공' || '실패' }}"
          COLOR="${{ job.status == 'success' && '65280' || '16711680' }}"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          curl -X POST -H "Content-Type: application/json" \
          -d '{
            "embeds": [{
              "title": "BE CD 결과 (Backend)",
              "description": "상태: '"${STATUS}"'\n브랜치: ${{ inputs.ref_name }}\n담당자: ${{ github.actor }}",
              "color": '"${COLOR}"',
              "fields": [
                {"name": "run_id(CI)", "value": "${{ inputs.run_id }}"},
                {"name": "로그 확인", "value": "'"${RUN_URL}"'"}
              ]
            }]
          }' \
          ${{ secrets.DISCORD_WEBHOOK }}
