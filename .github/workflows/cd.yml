name: backend-cd

on:
  # 자동 배포 트리거
  # develop에 push(=develop로 PR merge)되면 개발서버 배포
  # main에 push(=main으로 PR merge)되면 운영서버 배포
  push:
    branches: [develop, main]
  workflow_dispatch: {}

permissions:
  contents: read

# 배포는 최신 커밋 기준
concurrency:
  group: backend-cd-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci:
    uses: ./.github/workflows/ci.yml
    secrets: inherit

  deploy:
    needs: [ci]
    runs-on: ubuntu-latest
    env:
      IS_PROD: ${{ github.ref_name == 'main' }}

      BE_HOST: ${{ github.ref_name == 'develop' && secrets.BE_HOST_DEV || secrets.BE_HOST }}
      DEPLOY_USER: ${{ github.ref_name == 'develop' && secrets.DEPLOY_USER_DEV || secrets.DEPLOY_USER }}
      SSH_PRIVATE_KEY: ${{ github.ref_name == 'develop' && secrets.SSH_PRIVATE_KEY_DEV || secrets.SSH_PRIVATE_KEY }}
      ENV_CONTENT: ${{ github.ref_name == 'develop' && secrets.ENV_DEV || secrets.ENV }}
      GCP_WIF_AWS_JSON_B64: ${{ github.ref_name == 'develop' && secrets.GCP_WIF_AWS_JSON_B64_DEV || secrets.GCP_WIF_AWS_JSON_B64 }}

    steps:
      - name: Download Backend Artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-jar-${{ github.sha }}
          path: ./artifact


      # 서버로 JAR 전송(SCP)
      - name: Upload JAR to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.BE_HOST }}
          username: ${{ env.DEPLOY_USER }}
          key: ${{ env.SSH_PRIVATE_KEY }}
          source: "artifact/*.jar"
          target: "/home/ubuntu/be/incoming"
          strip_components: 1

      # 서버에서 배포 스크립트 실행(SSH)
      # 1. .env를 서버에 생성/갱신
      # 2. deploy.sh 실행
      - name: Execute Backend Deploy Script
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.BE_HOST }}
          username: ${{ env.DEPLOY_USER }}
          key: ${{ env.SSH_PRIVATE_KEY }}
          script: |
            cat << 'EOF' > /home/ubuntu/be/.env
            ${{ env.ENV_CONTENT }}
            EOF
            umask 077
            echo '${{ env.GCP_WIF_AWS_JSON_B64 }}' | base64 -d > /home/ubuntu/be/gcp-wif-aws.json
            chmod +x /home/ubuntu/be/deploy.sh
            bash /home/ubuntu/be/deploy.sh

      - name: Notify Discord
        if: always()
        run: |
          STATUS="${{ job.status == 'success' && '성공' || '실패' }}"
          COLOR="${{ job.status == 'success' && '65280' || '16711680' }}"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          curl -X POST -H "Content-Type: application/json" \
          -d '{
            "embeds": [{
              "title": "BE CD 결과 (Backend)",
              "description": "상태: '"${STATUS}"'\n브랜치: ${{ github.ref_name }}\n담당자: ${{ github.actor }}",
              "color": '"${COLOR}"',
              "fields": [
                {"name": "커밋 메시지", "value": "${{ github.event.head_commit.message || 'Manual Trigger' }}"},
                {"name": "로그 확인", "value": "'"${RUN_URL}"'"}
              ]
            }]
          }' \
          ${{ secrets.DISCORD_WEBHOOK }}
